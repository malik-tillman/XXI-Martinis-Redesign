{% liquid
  assign subheading = section.settings.subheading
  assign productTitle = product.title
  assign description = product.description
  assign productPrice = product.price | money
  assign button_text = section.settings.button_text
  assign button_link = section.settings.button_link
%}

<section class="main--product">
  <div class="product--media-container">
    <div class="productSlider swiper {{ section.id }}">
      <div class="swiper-wrapper">
        {%- for image in product.images -%}
          <div class="product--slideshow--image swiper-slide">
            <div class="image--container">
              <img src="{{ image.src | img_url: 'master' }}" alt="{{ product.title }}">
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <div class="thumbSlider swiper {{ section.id }}">
      <div class="swiper-wrapper">
        {%- for image in product.images -%}
          <div class="product--slideshow--image swiper-slide">
            <div class="image--container">
              <img src="{{ image.src | img_url: 'master' }}" alt="{{ product.title }}">
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </div>

  <div class="product--details-container container rte">
    {% if subheading != blank %}
      <p class="sub-title">{{ subheading }}</p>
    {% endif %}

    {% if productTitle != blank %}
      <h1 class="title">{{ productTitle }}</h1>
    {% endif %}

    {% if productPrice != blank %}
      <p class="price sub-title">{{ productPrice }}</p>
    {% endif %}

    {% if description != blank %}
      <div class="description">{{ description }}</div>
    {% endif %}

    <div class="flavors--container">
      <h2 class="flavor--title">
        Flavor: {{ product.title }}
      </h2>

      <div class="flavor--list">
        {% for block in section.blocks %}
          {% liquid
            if request.path != block.settings.link
              continue
            endif

            assign activeAccent = block.settings.accent
          %}

          <a href="{{ block.settings.link }}" class="flavor--item {{ block.id }} active" style="--accent-color: {{ block.settings.accent | color_to_rgb }}">
            <div class="flavor--image--container">
              <img src="{{ block.settings.image | img_url: 'master' }}" alt="Go to {{ block.settings.url }}">
            </div>
          </a>
        {% endfor %}

        {% for block in section.blocks %}
          {% liquid
            if request.path == block.settings.link
              continue
            endif
          %}

          <a href="{{ block.settings.link }}" class="flavor--item {{ block.id }}" style="--accent-color: {{ block.settings.accent | color_to_rgb }}">
            <div class="flavor--image--container">
                <img src="{{ block.settings.image | img_url: 'master' }}" alt="Go to {{ block.settings.url }}">
            </div>
          </a>
        {% endfor %}
      </div>
    </div>

    {% if button_text != blank or button_link != blank %}
      <a href="{{ button_link }}" class="btn">
        {{ button_text }}
      </a>
    {% endif %}
  </div>
</section>

{% comment %}Search each article and check if any have this product as a {% endcomment %}
{% liquid
  assign has_article = false

  for article in blogs['recipes'].articles
    if has_article
      break
    endif

    for associated_product in article.metafields.custom.associated_product.value
      if associated_product.id == product.id
        assign has_article = true
        break
      endif
    endfor
  endfor
%}

{% if has_article %}
  <div class="main--product-recipes container rte">
    <h2 class="text">{{ section.settings.recipes_heading }}</h2>

    <div class="recipes--container">
      {% assign count = 0 %}
      {% for recipe in blogs['recipes'].articles %}
        {% liquid
          if count == 3
            break
          endif

          assign is_associated = false

          for associated_product in recipe.metafields.custom.associated_product.value
            if is_associated
              break
            endif

            if associated_product.id == product.id
              assign is_associated = true
              break
            endif
          endfor

          unless is_associated
            continue
          endunless

          assign count = count | plus: 1
        %}

        <a href="{{ recipe.url }}" class="recipe--item">
          <div class="recipe--image--container">
              <img src="{{ recipe.image | img_url: 'master' }}" alt="{{ recipe.title }}">
          </div>

          <h3>{{ recipe.title }}</h3>
        </a>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% if activeAccent %}
  <style>
    :root {
      --page-accent: {{ activeAccent | color_to_rgb }};
      --page-accent-2: rgba({{ activeAccent.rgb | replace: ' ', ', ' }}, 0.5);
    }
  </style>
{% else %}
  <style>
    :root {
      --page-accent: black;
      --page-accent-2: rgba(0, 0, 0, 0.5);
    }
  </style>
{% endif %}

<script>
  const thumbSlider = new Swiper('.{{ section.id }}.thumbSlider', {
    spaceBetween: 10,
    slidesPerView: 4,
    slidesPerGroup: 1,
    loop: true,
    freeMode: false,
    watchSlidesProgress: true,
    slideToClickedSlide: true,
    grabCursor: true,
    arrows: false,
    navigation: {
      enabled: false,
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
  });

  const productSlider = new Swiper('.{{ section.id }}.productSlider', {
    loop: true,
    slidesPerView: 1,
    autoHeight: true,
    grabCursor: true,
    navigation: {
      enabled: false,
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    thumbs: {
      swiper: thumbSlider
    }
  });
</script>

{% schema %}
{
  "name": "Main Product",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "flavor",
      "name": "Flavor",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "color",
          "id": "accent",
          "label": "Accent Color",
          "default": "#ffffff"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "XXI Martinis"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Where to Buy"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "CTA Link"
    },
    {
      "type": "text",
      "id": "recipes_heading",
      "label": "Recipes Heading",
      "default": "Perfect For:"
    }
  ]
}
{% endschema %}
